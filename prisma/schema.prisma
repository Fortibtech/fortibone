generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [postgis]
}

model User {
  id                          String               @id @default(cuid())
  email                       String               @unique
  password                    String
  firstName                   String               @map("first_name")
  lastName                    String?              @map("last_name")
  phoneNumber                 String?              @map("phone_number")
  profileImageUrl             String?              @map("profile_image_url")
  createdAt                   DateTime             @default(now()) @map("created_at")
  updatedAt                   DateTime             @updatedAt @map("updated_at")
  profileType                 ProfileType          @default(PARTICULIER)
  isEmailVerified             Boolean              @default(false) @map("is_email_verified")
  otp                         String?
  otpExpiresAt                DateTime?            @map("otp_expires_at")
  passwordResetToken          String?              @map("password_reset_token")
  passwordResetTokenExpiresAt DateTime?            @map("password_reset_token_expires_at")
  city                        String?
  country                     String?
  dateOfBirth                 DateTime?            @map("date_of_birth")
  gender                      Gender?
  lastOtpSentAt               DateTime?            @map("last_otp_sent_at")
  stripeAccountId             String?              @unique @map("stripe_account_id")
  stripeAccountSetupComplete  Boolean              @default(false) @map("stripe_account_setup_complete")
  businesses                  Business[]
  memberships                 BusinessMember[]
  businessReviews             BusinessReview[]
  favoriteProducts            FavoriteProduct[]
  invitations                 Invitation[]
  ordersAsCustomer            Order[]              @relation("CustomerOrders")
  ordersAsEmployee            Order[]              @relation("EmployeeActions")
  orderStatusTriggered        OrderStatusHistory[]
  reviews                     Review[]
  stockMovements              StockMovement[]
  wallet                      Wallet?
}

model Currency {
  id           String     @id @default(cuid())
  code         String     @unique
  name         String
  symbol       String
  exchangeRate Float      @default(1) @map("exchange_rate")
  businesses   Business[]
  wallets      Wallet[]
}

model Business {
  id                  String                   @id @default(cuid())
  name                String
  description         String?
  type                BusinessType
  logoUrl             String?                  @map("logo_url")
  coverImageUrl       String?                  @map("cover_image_url")
  address             String?
  phoneNumber         String?                  @map("phone_number")
  location            Unsupported("geometry")?
  isVerified          Boolean                  @default(false) @map("is_verified")
  createdAt           DateTime                 @default(now()) @map("created_at")
  updatedAt           DateTime                 @updatedAt @map("updated_at")
  ownerId             String                   @map("owner_id")
  averageRating       Float                    @default(0) @map("average_rating")
  currencyId          String?                  @map("currency_id")
  reviewCount         Int                      @default(0) @map("review_count")
  activitySector      String?                  @map("activity_sector")
  commerceType        CommerceType             @default(PHYSICAL) @map("commerce_type")
  siret               String?                  @unique
  websiteUrl          String?                  @map("website_url")
  avgDeliveryTime     String?                  @map("avg_delivery_time")
  clientReferences    String?                  @map("client_references")
  contactCivility     Civility?
  contactFirstName    String?                  @map("contact_first_name")
  contactFunction     String?                  @map("contact_function")
  contactLastName     String?                  @map("contact_last_name")
  deliveryZones       String[]
  detailedDescription String?                  @map("detailed_description")
  minOrderQuantity    Int?                     @map("min_order_quantity")
  paymentConditions   String[]
  postalCode          String?                  @map("postal_code")
  priceRange          PriceRange?
  productCategories   String[]
  productionVolume    String?                  @map("production_volume")
  sampleAvailable     Boolean?                 @map("sample_available")
  socialLinks         Json?                    @map("social_links")
  currency            Currency?                @relation(fields: [currencyId], references: [id])
  owner               User                     @relation(fields: [ownerId], references: [id])
  members             BusinessMember[]
  reviews             BusinessReview[]
  invitations         Invitation[]
  menus               Menu[]
  openingHours        OpeningHour[]
  ordersReceived      Order[]                  @relation("BusinessOrders")
  ordersPlaced        Order[]                  @relation("BusinessPurchases")
  products            Product[]
  restaurantTables    RestaurantTable[]
  stockMovements      StockMovement[]
}

model OpeningHour {
  id         String    @id @default(cuid())
  dayOfWeek  DayOfWeek @map("day_of_week")
  openTime   String    @map("open_time")
  closeTime  String    @map("close_time")
  businessId String    @map("business_id")
  business   Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, dayOfWeek, openTime, closeTime])
}

model BusinessReview {
  id         String   @id @default(cuid())
  rating     Int
  comment    String?
  createdAt  DateTime @default(now()) @map("created_at")
  businessId String   @map("business_id")
  authorId   String   @map("author_id")
  author     User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, authorId])
}

model BusinessMember {
  id         String     @id @default(cuid())
  role       MemberRole
  userId     String     @map("user_id")
  businessId String     @map("business_id")
  createdAt  DateTime   @default(now()) @map("created_at")
  business   Business   @relation(fields: [businessId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, businessId])
}

model Category {
  id          String              @id @default(cuid())
  name        String              @unique
  description String?
  imageUrl    String?             @map("image_url")
  attributes  CategoryAttribute[]
  products    Product[]
}

model CategoryAttribute {
  id            String                  @id @default(cuid())
  name          String
  categoryId    String                  @map("category_id")
  category      Category                @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  variantValues VariantAttributeValue[]

  @@unique([name, categoryId])
}

model Product {
  id            String            @id @default(cuid())
  name          String
  description   String?
  salesUnit     SalesUnit         @default(UNIT)
  businessId    String            @map("business_id")
  categoryId    String            @map("category_id")
  imageUrl      String?           @map("image_url")
  averageRating Float             @default(0) @map("average_rating")
  reviewCount   Int               @default(0) @map("review_count")
  favoritedBy   FavoriteProduct[]
  business      Business          @relation(fields: [businessId], references: [id], onDelete: Cascade)
  category      Category          @relation(fields: [categoryId], references: [id])
  variants      ProductVariant[]
  reviews       Review[]
}

model ProductBatch {
  id             String         @id @default(cuid())
  quantity       Int
  expirationDate DateTime?      @map("expiration_date")
  receivedAt     DateTime       @default(now()) @map("received_at")
  variantId      String         @map("variant_id")
  variant        ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
}

model ProductVariant {
  id              String                  @id @default(cuid())
  sku             String?                 @unique
  barcode         String?                 @unique
  price           Decimal
  purchasePrice   Decimal                 @map("purchase_price")
  quantityInStock Int                     @default(0) @map("quantity_in_stock")
  alertThreshold  Int?                    @map("alert_threshold")
  itemsPerLot     Int?                    @map("items_per_lot")
  lotPrice        Decimal?                @map("lot_price")
  productId       String                  @map("product_id")
  imageUrl        String?                 @map("image_url")
  menuItems       MenuItem[]
  orderLines      OrderLine[]
  batches         ProductBatch[]
  product         Product                 @relation(fields: [productId], references: [id], onDelete: Cascade)
  stockMovements  StockMovement[]
  attributeValues VariantAttributeValue[]
}

model VariantAttributeValue {
  id          String            @id @default(cuid())
  value       String
  variantId   String            @map("variant_id")
  attributeId String            @map("attribute_id")
  attribute   CategoryAttribute @relation(fields: [attributeId], references: [id], onDelete: Cascade)
  variant     ProductVariant    @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@unique([variantId, attributeId])
}

model FavoriteProduct {
  userId     String   @map("user_id")
  productId  String   @map("product_id")
  assignedAt DateTime @default(now()) @map("assigned_at")
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, productId])
}

model StockMovement {
  id             String         @id @default(cuid())
  type           MovementType
  quantityChange Int            @map("quantity_change")
  newQuantity    Int            @map("new_quantity")
  reason         String?
  createdAt      DateTime       @default(now()) @map("created_at")
  variantId      String         @map("variant_id")
  businessId     String         @map("business_id")
  orderId        String?        @map("order_id")
  performedById  String         @map("performed_by_id")
  business       Business       @relation(fields: [businessId], references: [id], onDelete: Cascade)
  order          Order?         @relation(fields: [orderId], references: [id])
  performedBy    User           @relation(fields: [performedById], references: [id])
  variant        ProductVariant @relation(fields: [variantId], references: [id])
}

model RestaurantTable {
  id          String   @id @default(cuid())
  name        String
  capacity    Int
  isAvailable Boolean  @default(true)
  businessId  String   @map("business_id")
  orders      Order[]
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, name])
}

model Menu {
  id          String     @id @default(cuid())
  name        String
  description String?
  price       Decimal
  isActive    Boolean    @default(true)
  businessId  String     @map("business_id")
  business    Business   @relation(fields: [businessId], references: [id], onDelete: Cascade)
  menuItems   MenuItem[]

  @@unique([businessId, name])
}

model MenuItem {
  id        String         @id @default(cuid())
  quantity  Int            @default(1)
  menuId    String         @map("menu_id")
  variantId String         @map("variant_id")
  menu      Menu           @relation(fields: [menuId], references: [id], onDelete: Cascade)
  variant   ProductVariant @relation(fields: [variantId], references: [id])

  @@unique([menuId, variantId])
}

model Order {
  id                     String               @id @default(cuid())
  orderNumber            String               @unique @map("order_number")
  type                   OrderType
  status                 OrderStatus          @default(PENDING)
  totalAmount            Decimal              @map("total_amount")
  notes                  String?
  createdAt              DateTime             @default(now()) @map("created_at")
  businessId             String               @map("business_id")
  customerId             String               @map("customer_id")
  purchasingBusinessId   String?              @map("purchasing_business_id")
  employeeId             String?              @map("employee_id")
  reservationDate        DateTime?            @map("reservation_date")
  paymentIntentId        String?              @unique @map("payment_intent_id")
  paymentMethod          PaymentMethodEnum?   @map("payment_method")
  transactionId          String?              @unique @map("transaction_id")
  tableId                String?              @map("table_id")
  discountAmount         Decimal              @default(0.0) @map("discount_amount")
  estimatedDeliveryDate  DateTime?            @map("estimated_delivery_date")
  shippingCarrier        String?              @map("shipping_carrier")
  shippingDate           DateTime?            @map("shipping_date")
  shippingFee            Decimal              @default(0.0) @map("shipping_fee")
  shippingMode           String?              @map("shipping_mode")
  shippingTrackingNumber String?              @map("shipping_tracking_number")
  subTotal               Decimal              @default(0.0) @map("sub_total")
  invoice                Invoice?
  business               Business             @relation("BusinessOrders", fields: [businessId], references: [id])
  customer               User                 @relation("CustomerOrders", fields: [customerId], references: [id])
  employee               User?                @relation("EmployeeActions", fields: [employeeId], references: [id], onDelete: Restrict)
  purchasingBusiness     Business?            @relation("BusinessPurchases", fields: [purchasingBusinessId], references: [id], onDelete: Restrict)
  table                  RestaurantTable?     @relation(fields: [tableId], references: [id])
  lines                  OrderLine[]
  statusHistory          OrderStatusHistory[]
  payments               PaymentTransaction[]
  stockMovements         StockMovement[]
  walletTransactions     WalletTransaction[]
}

model OrderLine {
  id        String         @id @default(cuid())
  quantity  Int
  price     Decimal
  orderId   String         @map("order_id")
  variantId String         @map("variant_id")
  order     Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  variant   ProductVariant @relation(fields: [variantId], references: [id])
}

model OrderStatusHistory {
  id            String      @id @default(cuid())
  status        OrderStatus
  notes         String?
  timestamp     DateTime    @default(now())
  orderId       String      @map("order_id")
  triggeredById String?     @map("triggered_by_id")
  order         Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  triggeredBy   User?       @relation(fields: [triggeredById], references: [id])
}

model PaymentTransaction {
  id                    String             @id @default(cuid())
  amount                Decimal
  currencyCode          String             @map("currency_code")
  provider              PaymentMethodEnum
  providerTransactionId String?            @unique @map("provider_transaction_id")
  status                PaymentStatus      @default(PENDING)
  metadata              Json?
  createdAt             DateTime           @default(now()) @map("created_at")
  updatedAt             DateTime           @updatedAt @map("updated_at")
  orderId               String?            @map("order_id")
  walletTransactionId   String?
  order                 Order?             @relation(fields: [orderId], references: [id], onDelete: Cascade)
  walletTransaction     WalletTransaction?
}

model Review {
  id        String   @id @default(cuid())
  rating    Int
  comment   String?
  createdAt DateTime @default(now()) @map("created_at")
  productId String   @map("product_id")
  authorId  String   @map("author_id")
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model Wallet {
  id           String              @id @default(cuid())
  balance      Decimal             @default(0.0)
  createdAt    DateTime            @default(now()) @map("created_at")
  updatedAt    DateTime            @updatedAt @map("updated_at")
  userId       String              @unique @map("user_id")
  currencyId   String              @map("currency_id")
  currency     Currency            @relation(fields: [currencyId], references: [id])
  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions WalletTransaction[]
}

model WalletTransaction {
  id                          String                  @id @default(cuid())
  type                        WalletTransactionType
  amount                      Decimal
  status                      WalletTransactionStatus @default(PENDING)
  description                 String
  createdAt                   DateTime                @default(now()) @map("created_at")
  walletId                    String                  @map("wallet_id")
  relatedOrderId              String?                 @map("related_order_id")
  relatedPaymentTransactionId String?                 @unique @map("related_payment_transaction_id")
  metadata                    Json?
  transferPeerTransactionId   String?                 @unique @map("transfer_peer_transaction_id")
  relatedOrder                Order?                  @relation(fields: [relatedOrderId], references: [id])
  relatedPaymentTransaction   PaymentTransaction?     @relation(fields: [relatedPaymentTransactionId], references: [id])
  transferPeerTransaction     WalletTransaction?      @relation("WalletTransfer", fields: [transferPeerTransactionId], references: [id], onDelete: NoAction)
  transferTransaction         WalletTransaction?      @relation("WalletTransfer")
  wallet                      Wallet                  @relation(fields: [walletId], references: [id], onDelete: Cascade)
}

model Invoice {
  id             String           @id @default(cuid())
  invoiceNumber  String           @unique @map("invoice_number")
  status         InvoiceStatus    @default(DRAFT)
  issueDate      DateTime         @default(now()) @map("issue_date")
  dueDate        DateTime         @map("due_date")
  pdfUrl         String?          @map("pdf_url")
  notes          String?
  subTotal       Decimal
  discountAmount Decimal          @default(0.0)
  shippingFee    Decimal          @default(0.0)
  totalAmount    Decimal
  orderId        String           @unique @map("order_id")
  order          Order            @relation(fields: [orderId], references: [id], onDelete: Cascade)
  payments       InvoicePayment[]
}

model InvoicePayment {
  id             String   @id @default(cuid())
  amountPaid     Decimal  @map("amount_paid")
  paymentDate    DateTime @default(now()) @map("payment_date")
  paymentMethod  String
  transactionRef String?  @unique @map("transaction_ref")
  invoiceId      String   @map("invoice_id")
  invoice        Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

model Invitation {
  id          String           @id @default(cuid())
  email       String
  token       String           @unique
  role        MemberRole
  status      InvitationStatus @default(PENDING)
  expiresAt   DateTime         @map("expires_at")
  businessId  String           @map("business_id")
  invitedById String           @map("invited_by_id")
  business    Business         @relation(fields: [businessId], references: [id], onDelete: Cascade)
  invitedBy   User             @relation(fields: [invitedById], references: [id], onDelete: Cascade)

  @@unique([email, businessId])
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model spatial_ref_sys {
  srid      Int     @id
  auth_name String? @db.VarChar(256)
  auth_srid Int?
  srtext    String? @db.VarChar(2048)
  proj4text String? @db.VarChar(2048)
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum ProfileType {
  PARTICULIER
  PRO
}

enum BusinessType {
  COMMERCANT
  FOURNISSEUR
  RESTAURATEUR
}

enum MemberRole {
  ADMIN
  MEMBER
}

enum SalesUnit {
  UNIT
  LOT
}

enum MovementType {
  INITIAL_STOCK
  PURCHASE_ENTRY
  SALE
  RETURN
  LOSS
  ADJUSTMENT
  EXPIRATION
}

enum OrderType {
  SALE
  PURCHASE
  RESERVATION
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  COMPLETED
  CANCELLED
  REFUNDED
  PENDING_PAYMENT
  PAID
  PAYMENT_FAILED
  REJECTED
  PENDING_APPROVAL
  PENDING_REFUND
  PARTIALLY_REFUNDED
  ARCHIVED
}

enum PaymentMethodEnum {
  STRIPE
  MVOLA
  MANUAL
  WALLET
  KARTAPAY
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
  PENDING_REFUND
}

enum Gender {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
}

enum WalletTransactionType {
  DEPOSIT
  WITHDRAWAL
  PAYMENT
  REFUND
  ADJUSTMENT
  TRANSFER
}

enum WalletTransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

enum CommerceType {
  PHYSICAL
  DIGITAL
  HYBRID
}

enum Civility {
  MR
  MRS
  MS
}

enum PriceRange {
  ENTRY_LEVEL
  MID_RANGE
  HIGH_END
  LUXURY
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  PARTIALLY_PAID
  VOID
}
